#!/bin/bash
# switch-shell - Switch between installed shells on RavenLinux
# Usage: switch-shell <shell>
# Example: switch-shell bash

set -e

SHELLS_FILE="/etc/shells"
SUPPORTED_SHELLS="zsh bash fish"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_usage() {
    echo -e "${BLUE}switch-shell${NC} - Switch between installed shells"
    echo ""
    echo "Usage: switch-shell <shell>"
    echo ""
    echo "Available shells:"
    for shell in $SUPPORTED_SHELLS; do
        shell_path=$(command -v $shell 2>/dev/null || echo "")
        if [ -n "$shell_path" ]; then
            if [ "$SHELL" = "$shell_path" ] || [ "$SHELL" = "/bin/$shell" ] || [ "$SHELL" = "/usr/bin/$shell" ]; then
                echo -e "  ${GREEN}$shell${NC} (current)"
            else
                echo "  $shell"
            fi
        else
            echo -e "  ${YELLOW}$shell${NC} (not installed)"
        fi
    done
    echo ""
    echo "Examples:"
    echo "  switch-shell bash    # Switch to bash"
    echo "  switch-shell zsh     # Switch to zsh"
    echo "  switch-shell fish    # Switch to fish"
}

copy_config() {
    local source_shell=$1
    local target_shell=$2
    local source_rc=""
    local target_rc=""

    # Determine source config
    case $source_shell in
        zsh)
            source_rc="$HOME/.zshrc"
            [ ! -f "$source_rc" ] && source_rc="/etc/zsh/zshrc"
            ;;
        bash)
            source_rc="$HOME/.bashrc"
            [ ! -f "$source_rc" ] && source_rc="/etc/bash/bashrc"
            ;;
        fish)
            source_rc="$HOME/.config/fish/config.fish"
            [ ! -f "$source_rc" ] && source_rc="/etc/fish/config.fish"
            ;;
    esac

    # Determine target config
    case $target_shell in
        zsh)
            target_rc="$HOME/.zshrc"
            ;;
        bash)
            target_rc="$HOME/.bashrc"
            ;;
        fish)
            mkdir -p "$HOME/.config/fish"
            target_rc="$HOME/.config/fish/config.fish"
            ;;
    esac

    # If target doesn't exist and source does, convert and copy
    if [ ! -f "$target_rc" ] && [ -f "$source_rc" ]; then
        echo -e "${YELLOW}Creating $target_rc from $source_rc...${NC}"

        if [ "$target_shell" = "fish" ] && [ "$source_shell" != "fish" ]; then
            # Convert bash/zsh syntax to fish
            convert_to_fish "$source_rc" "$target_rc"
        elif [ "$target_shell" != "fish" ] && [ "$source_shell" = "fish" ]; then
            # Convert fish to bash/zsh
            convert_from_fish "$source_rc" "$target_rc" "$target_shell"
        else
            # Same shell family, just copy with header
            {
                echo "# Converted from $source_shell config"
                echo "# Original: $source_rc"
                echo ""
                cat "$source_rc"
            } > "$target_rc"
        fi
        echo -e "${GREEN}Created $target_rc${NC}"
    elif [ ! -f "$target_rc" ]; then
        # No source to copy from, use system default
        case $target_shell in
            zsh)
                [ -f /etc/zsh/zshrc ] && cp /etc/zsh/zshrc "$target_rc"
                ;;
            bash)
                [ -f /etc/bash/bashrc ] && cp /etc/bash/bashrc "$target_rc"
                ;;
            fish)
                mkdir -p "$HOME/.config/fish"
                [ -f /etc/fish/config.fish ] && cp /etc/fish/config.fish "$target_rc"
                ;;
        esac
        [ -f "$target_rc" ] && echo -e "${GREEN}Created $target_rc from system defaults${NC}"
    fi
}

convert_to_fish() {
    local source=$1
    local target=$2

    cat > "$target" << 'FISHHEAD'
# RavenLinux fish config (converted from bash/zsh)
# Some settings may need manual adjustment

FISHHEAD

    # Extract and convert aliases
    grep "^alias " "$source" 2>/dev/null | while read line; do
        # Convert alias name='command' to alias name 'command'
        name=$(echo "$line" | sed "s/^alias \([^=]*\)=.*/\1/")
        cmd=$(echo "$line" | sed "s/^alias [^=]*='\(.*\)'/\1/" | sed "s/^alias [^=]*=\"\(.*\)\"/\1/")
        echo "alias $name '$cmd'" >> "$target"
    done

    # Add basic fish-compatible settings
    cat >> "$target" << 'FISHTAIL'

# Environment
set -gx RAVEN_LINUX 1
set -gx EDITOR raven-editor
set -gx VISUAL raven-editor

# Prompt
function fish_prompt
    echo -n "[$(whoami)@raven-linux]# "
end

# Load local config if exists
if test -f ~/.config/fish/config.fish.local
    source ~/.config/fish/config.fish.local
end
FISHTAIL
}

convert_from_fish() {
    local source=$1
    local target=$2
    local target_shell=$3

    cat > "$target" << 'BASHHEAD'
# RavenLinux config (converted from fish)
# Some settings may need manual adjustment

BASHHEAD

    # Extract and convert aliases
    grep "^alias " "$source" 2>/dev/null | while read line; do
        # Convert alias name 'command' to alias name='command'
        name=$(echo "$line" | sed "s/^alias \([^ ]*\) .*/\1/")
        cmd=$(echo "$line" | sed "s/^alias [^ ]* '\(.*\)'/\1/")
        echo "alias $name='$cmd'" >> "$target"
    done

    # Add basic settings
    cat >> "$target" << 'BASHTAIL'

# Environment
export RAVEN_LINUX=1
export EDITOR="${EDITOR:-raven-editor}"
export VISUAL="${VISUAL:-raven-editor}"

# Prompt
PS1='[\u@raven-linux]# '

# Load local config if exists
BASHTAIL

    if [ "$target_shell" = "zsh" ]; then
        echo '[ -f ~/.zshrc.local ] && source ~/.zshrc.local' >> "$target"
    else
        echo '[ -f ~/.bashrc.local ] && source ~/.bashrc.local' >> "$target"
    fi
}

get_current_shell() {
    basename "$SHELL"
}

# Main script
if [ $# -eq 0 ]; then
    print_usage
    exit 0
fi

TARGET_SHELL=$1

# Validate shell name
case $TARGET_SHELL in
    zsh|bash|fish)
        ;;
    *)
        echo -e "${RED}Error: Unknown shell '$TARGET_SHELL'${NC}"
        echo "Supported shells: $SUPPORTED_SHELLS"
        exit 1
        ;;
esac

# Find shell path
SHELL_PATH=$(command -v $TARGET_SHELL 2>/dev/null || echo "")

if [ -z "$SHELL_PATH" ]; then
    echo -e "${RED}Error: $TARGET_SHELL is not installed${NC}"
    echo "Install it with: rvn install $TARGET_SHELL"
    exit 1
fi

# Check if shell is in /etc/shells
if [ -f "$SHELLS_FILE" ]; then
    if ! grep -q "^$SHELL_PATH$" "$SHELLS_FILE" 2>/dev/null; then
        echo -e "${YELLOW}Warning: $SHELL_PATH not in $SHELLS_FILE${NC}"
        echo "Adding it now (requires root)..."
        echo "$SHELL_PATH" | sudo tee -a "$SHELLS_FILE" > /dev/null
    fi
fi

# Get current shell for config copying
CURRENT_SHELL=$(get_current_shell)

# Copy config if needed
copy_config "$CURRENT_SHELL" "$TARGET_SHELL"

# Change shell
echo -e "${BLUE}Changing shell to $TARGET_SHELL...${NC}"
if chsh -s "$SHELL_PATH"; then
    echo -e "${GREEN}Shell changed to $TARGET_SHELL${NC}"
    echo ""
    echo "To use the new shell immediately, run:"
    echo -e "  ${BLUE}exec $TARGET_SHELL${NC}"
    echo ""
    echo "Or log out and log back in."
else
    echo -e "${RED}Failed to change shell${NC}"
    exit 1
fi
