# =============================================================================
# RavenLinux Build Workflow
# =============================================================================
# Builds all components and creates releases
#
# Triggers:
#   - Push to main branch
#   - Pull requests to main
#   - Manual workflow dispatch
#   - Tags matching v*.*.*
#
# Jobs:
#   1. Build Rust components (rvn, init, bootloader, installer)
#   2. Build Linux kernel (on release only)
#   3. Create ISO image (on release only)
#   4. Create GitHub release with artifacts

name: Build RavenLinux

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_kernel:
        description: 'Build Linux kernel'
        required: false
        default: false
        type: boolean
      build_iso:
        description: 'Build ISO image'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Build Rust Components
  # ===========================================================================
  build-rust:
    name: Build Rust Components
    runs-on: ubuntu-latest

    strategy:
      matrix:
        component:
          - name: rvn
            path: tools/rvn
            binary: rvn
          - name: raven-init
            path: init
            binary: raven-init
          - name: raven-rc
            path: init
            binary: raven-rc
          - name: raven-installer
            path: installer
            binary: raven-installer

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ matrix.component.path }}/target
          key: ${{ runner.os }}-cargo-${{ matrix.component.name }}-${{ hashFiles(format('{0}/Cargo.lock', matrix.component.path)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.component.name }}-

      - name: Check formatting
        run: cargo fmt --check
        working-directory: ${{ matrix.component.path }}
        continue-on-error: true

      - name: Run Clippy
        run: cargo clippy --release -- -D warnings
        working-directory: ${{ matrix.component.path }}
        continue-on-error: true

      - name: Build release binary
        run: cargo build --release
        working-directory: ${{ matrix.component.path }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.component.binary }}-linux-x86_64
          path: ${{ matrix.component.path }}/target/release/${{ matrix.component.binary }}
          if-no-files-found: error

  # ===========================================================================
  # Build UEFI Bootloader
  # ===========================================================================
  build-bootloader:
    name: Build UEFI Bootloader
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          targets: x86_64-unknown-uefi

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            bootloader/target
          key: ${{ runner.os }}-cargo-bootloader-${{ hashFiles('bootloader/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bootloader-

      - name: Build bootloader
        run: cargo build --release --target x86_64-unknown-uefi
        working-directory: bootloader

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: raven-boot-efi
          path: bootloader/target/x86_64-unknown-uefi/release/raven-boot.efi
          if-no-files-found: error

  # ===========================================================================
  # Build Linux Kernel (Release only or manual)
  # ===========================================================================
  build-kernel:
    name: Build Linux Kernel
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.build_kernel == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libncurses-dev \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            bc \
            cpio \
            rsync

      - name: Cache kernel source
        uses: actions/cache@v4
        with:
          path: linux-*
          key: linux-kernel-6.11.0

      - name: Download kernel source
        run: |
          if [ ! -d "linux-6.11" ]; then
            wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.11.tar.xz
            tar xf linux-6.11.tar.xz
            rm linux-6.11.tar.xz
          fi

      - name: Configure kernel
        run: |
          cd linux-6.11
          # Use RavenLinux kernel config if available, otherwise use default
          if [ -f ../configs/kernel/config-x86_64 ]; then
            cp ../configs/kernel/config-x86_64 .config
          else
            make defconfig
            # Enable required options for modern boot
            scripts/config --enable EFI
            scripts/config --enable EFI_STUB
            scripts/config --enable IKCONFIG
            scripts/config --enable IKCONFIG_PROC
          fi
          make olddefconfig

      - name: Build kernel
        run: |
          cd linux-6.11
          make -j$(nproc) bzImage

      - name: Upload kernel
        uses: actions/upload-artifact@v4
        with:
          name: linux-kernel
          path: linux-6.11/arch/x86/boot/bzImage
          if-no-files-found: error

  # ===========================================================================
  # Build ISO Image (Release only or manual)
  # ===========================================================================
  build-iso:
    name: Build ISO Image
    runs-on: ubuntu-latest
    needs: [build-rust, build-bootloader, build-kernel]
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.build_iso == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xorriso \
            mtools \
            dosfstools \
            grub-efi-amd64-bin \
            cpio \
            zstd

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Build ISO
        run: |
          chmod +x scripts/stage4-iso.sh
          ./scripts/stage4-iso.sh
        env:
          ARTIFACTS_DIR: ${{ github.workspace }}/artifacts

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: ravenlinux-iso
          path: "*.iso"
          if-no-files-found: warn

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-rust, build-bootloader]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Package manager
          cp artifacts/rvn-linux-x86_64/rvn release/rvn-linux-x86_64
          chmod +x release/rvn-linux-x86_64

          # Init system
          cp artifacts/raven-init-linux-x86_64/raven-init release/raven-init-linux-x86_64
          cp artifacts/raven-rc-linux-x86_64/raven-rc release/raven-rc-linux-x86_64
          chmod +x release/raven-init-linux-x86_64 release/raven-rc-linux-x86_64

          # Bootloader
          cp artifacts/raven-boot-efi/raven-boot.efi release/raven-boot.efi

          # Installer
          cp artifacts/raven-installer-linux-x86_64/raven-installer release/raven-installer-linux-x86_64
          chmod +x release/raven-installer-linux-x86_64

          # Create checksums
          cd release
          sha256sum * > SHA256SUMS

          # Create tarball
          cd ..
          tar czvf ravenlinux-tools-${{ github.ref_name }}-linux-x86_64.tar.gz -C release .

      - name: Generate release notes
        run: |
          cat << 'EOF' > RELEASE_NOTES.md
          # RavenLinux ${{ github.ref_name }}

          ## Components

          | Component | Description |
          |-----------|-------------|
          | `rvn` | RavenLinux package manager |
          | `raven-init` | Init system (PID 1) |
          | `raven-rc` | Init control utility |
          | `raven-boot.efi` | UEFI bootloader |
          | `raven-installer` | System installer |

          ## Installation

          ### Bootloader
          Copy `raven-boot.efi` to `/EFI/raven/` on your EFI System Partition.

          ### Package Manager
          ```bash
          sudo install -m 755 rvn-linux-x86_64 /usr/local/bin/rvn
          ```

          ### Init System
          ```bash
          sudo install -m 755 raven-init-linux-x86_64 /sbin/raven-init
          sudo install -m 755 raven-rc-linux-x86_64 /sbin/raven-rc
          sudo ln -sf raven-init /sbin/init
          sudo ln -sf raven-rc /sbin/poweroff
          sudo ln -sf raven-rc /sbin/reboot
          sudo ln -sf raven-rc /sbin/halt
          ```

          ## Checksums

          See `SHA256SUMS` file for verification.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            ravenlinux-tools-${{ github.ref_name }}-linux-x86_64.tar.gz
            release/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Full ISO Release (when kernel is built)
  # ===========================================================================
  release-iso:
    name: Release ISO
    runs-on: ubuntu-latest
    needs: [build-iso, release]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: ravenlinux-iso
          path: iso

      - name: Upload ISO to release
        uses: softprops/action-gh-release@v1
        with:
          files: iso/*.iso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
