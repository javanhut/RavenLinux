# =============================================================================
# RavenLinux Build Workflow
# =============================================================================
# Builds all components and creates releases
#
# Triggers:
#   - Push to main branch
#   - Pull requests to main
#   - Manual workflow dispatch
#   - Tags matching v*.*.*
#
# Jobs:
#   1. Build Rust components (rvn, init, bootloader, installer)
#   2. Build Linux kernel (on release only)
#   3. Create ISO image (on release only)
#   4. Create GitHub release with artifacts

name: Build RavenLinux

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_kernel:
        description: 'Build Linux kernel'
        required: false
        default: false
        type: boolean
      build_iso:
        description: 'Build ISO image'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RAVEN_VERSION: "2025.12"
  KERNEL_VERSION: "6.17.11"

jobs:
  # ===========================================================================
  # Build Go Components
  # ===========================================================================
  build-go:
    name: Build Go Components
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install GUI dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev libxkbcommon-dev libxkbcommon-x11-dev \
            libx11-dev libxcursor-dev libxrandr-dev libxinerama-dev \
            libxi-dev libxxf86vm-dev libwayland-dev pkg-config \
            libvulkan-dev libx11-xcb-dev libxcb-icccm4-dev libxcb-image0-dev \
            libxcb-keysyms1-dev libxcb-randr0-dev libxcb-render-util0-dev \
            libxcb-xfixes0-dev libxcb-xinerama0-dev libxcb-xkb-dev \
            libegl1-mesa-dev libwayland-egl1-mesa

      - name: Build Vem (text editor)
        run: |
          mkdir -p build/packages/bin build/sources
          git clone --depth 1 https://github.com/javanhut/Vem.git build/sources/vem
          cd build/sources/vem
          CGO_ENABLED=1 go build -o ../../../vem .

      - name: Build Carrion (programming language)
        run: |
          git clone --depth 1 https://github.com/javanhut/TheCarrionLanguage.git build/sources/carrion
          cd build/sources/carrion
          CGO_ENABLED=0 go build -o ../../../carrion ./src/main.go

      - name: Build Ivaldi (version control)
        run: |
          git clone --depth 1 https://github.com/javanhut/IvaldiVCS.git build/sources/ivaldi
          cd build/sources/ivaldi
          CGO_ENABLED=0 go build -o ../../../ivaldi .

      - name: Build raven-installer
        run: |
          cd tools/raven-installer
          go mod tidy
          CGO_ENABLED=1 go build -o ../../raven-installer .

      - name: Build raven-usb
        run: |
          cd tools/raven-usb
          go mod tidy
          CGO_ENABLED=1 go build -o ../../raven-usb .

      - name: Build raven-wifi (GUI)
        run: |
          cd tools/raven-wifi
          go mod tidy
          CGO_ENABLED=1 go build -o ../../raven-wifi .

      - name: Build wifi (TUI)
        run: |
          cd tools/raven-wifi-tui
          go mod tidy
          CGO_ENABLED=0 go build -o ../../wifi .

      - name: Upload Go packages
        uses: actions/upload-artifact@v4
        with:
          name: go-packages
          path: |
            vem
            carrion
            ivaldi
            raven-installer
            raven-usb
            raven-wifi
            wifi
          if-no-files-found: error


  # ===========================================================================
  # Build Rust Components
  # ===========================================================================
  build-rust:
    name: Build Rust Components
    runs-on: ubuntu-latest

    strategy:
      matrix:
        component:
          - name: rvn
            path: tools/rvn
            binary: rvn
          - name: raven-init
            path: init
            binary: raven-init
          - name: raven-rc
            path: init
            binary: raven-rc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ matrix.component.path }}/target
          key: ${{ runner.os }}-cargo-${{ matrix.component.name }}-${{ hashFiles(format('{0}/Cargo.lock', matrix.component.path)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.component.name }}-

      - name: Check formatting
        run: cargo fmt --check
        working-directory: ${{ matrix.component.path }}
        continue-on-error: true

      - name: Run Clippy
        run: cargo clippy --release -- -D warnings
        working-directory: ${{ matrix.component.path }}
        continue-on-error: true

      - name: Build release binary
        run: cargo build --release
        working-directory: ${{ matrix.component.path }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.component.binary }}-linux-x86_64
          path: ${{ matrix.component.path }}/target/release/${{ matrix.component.binary }}
          if-no-files-found: error

  # ===========================================================================
  # Build UEFI Bootloader
  # ===========================================================================
  build-bootloader:
    name: Build UEFI Bootloader
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-uefi

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            bootloader/target
          key: ${{ runner.os }}-cargo-bootloader-${{ hashFiles('bootloader/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bootloader-

      - name: Build bootloader
        run: cargo build --release --target x86_64-unknown-uefi
        working-directory: bootloader

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: raven-boot-efi
          path: bootloader/target/x86_64-unknown-uefi/release/raven-boot.efi
          if-no-files-found: error

  # ===========================================================================
  # Build Linux Kernel (Release only or manual)
  # ===========================================================================
  build-kernel:
    name: Build Linux Kernel
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.build_kernel == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libncurses-dev \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            bc \
            cpio \
            rsync

      - name: Cache kernel source
        uses: actions/cache@v4
        with:
          path: build/sources/linux-${{ env.KERNEL_VERSION }}*
          key: linux-kernel-${{ env.KERNEL_VERSION }}

      - name: Download kernel source
        run: |
          mkdir -p build/sources
          cd build/sources
          if [ ! -d "linux-${{ env.KERNEL_VERSION }}" ]; then
            wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_VERSION }}.tar.xz
            tar xf linux-${{ env.KERNEL_VERSION }}.tar.xz
          fi

      - name: Configure kernel
        run: |
          cd build/sources/linux-${{ env.KERNEL_VERSION }}
          # Use RavenLinux kernel config if available, otherwise use default
          if [ -f ../../../configs/kernel/config-x86_64 ]; then
            cp ../../../configs/kernel/config-x86_64 .config
          else
            make defconfig
            # Enable required options for modern boot
            scripts/config --enable EFI
            scripts/config --enable EFI_STUB
            scripts/config --enable IKCONFIG
            scripts/config --enable IKCONFIG_PROC
            scripts/config --enable ZSTD_COMPRESS
            scripts/config --enable KERNEL_ZSTD
          fi
          # Set local version
          scripts/config --set-str LOCALVERSION "-raven"
          make olddefconfig

      - name: Build kernel
        run: |
          cd build/sources/linux-${{ env.KERNEL_VERSION }}
          make -j$(nproc) bzImage modules

      - name: Package kernel
        run: |
          mkdir -p build/kernel/boot
          cp build/sources/linux-${{ env.KERNEL_VERSION }}/arch/x86/boot/bzImage build/kernel/boot/vmlinuz-raven
          cp build/sources/linux-${{ env.KERNEL_VERSION }}/System.map build/kernel/boot/System.map-raven
          cp build/sources/linux-${{ env.KERNEL_VERSION }}/.config build/kernel/boot/config-raven

      - name: Upload kernel
        uses: actions/upload-artifact@v4
        with:
          name: linux-kernel
          path: build/kernel/boot/
          if-no-files-found: error

  # ===========================================================================
  # Build ISO Image (Release only or manual)
  # ===========================================================================
  build-iso:
    name: Build ISO Image
    runs-on: ubuntu-latest
    needs: [build-go, build-rust, build-bootloader, build-kernel]
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.build_iso == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xorriso \
            mtools \
            dosfstools \
            grub-efi-amd64-bin \
            grub-pc-bin \
            squashfs-tools \
            cpio \
            zstd \
            bash \
            zsh

      - name: Download kernel artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-kernel
          path: build/kernel/boot/

      - name: Download Go packages
        uses: actions/download-artifact@v4
        with:
          name: go-packages
          path: build/packages/bin/

      - name: Download rvn package manager
        uses: actions/download-artifact@v4
        with:
          name: rvn-linux-x86_64
          path: build/packages/bin/
        continue-on-error: true

      - name: Download bootloader
        uses: actions/download-artifact@v4
        with:
          name: raven-boot-efi
          path: build/packages/boot/

      - name: Install Rust toolchain for uutils
        uses: dtolnay/rust-toolchain@stable

      - name: Build uutils-coreutils
        run: |
          mkdir -p build/bin
          git clone --depth 1 https://github.com/uutils/coreutils.git build/sources/uutils-coreutils
          cd build/sources/uutils-coreutils
          cargo build --release --features unix
          cp target/release/coreutils ../../bin/coreutils
          chmod +x ../../bin/coreutils

      - name: Prepare packages
        run: |
          # Make downloaded binaries executable and rename them
          chmod +x build/packages/bin/* 2>/dev/null || true
          chmod +x build/packages/boot/* 2>/dev/null || true

          # Rename binaries to expected names (remove -linux-x86_64 suffix if present)
          cd build/packages/bin
          for f in *-linux-x86_64; do
            [ -f "$f" ] && mv "$f" "${f%-linux-x86_64}" 2>/dev/null || true
          done
          cd -

          # Ensure rvn is in place
          if [ -f build/packages/bin/rvn ]; then
            chmod +x build/packages/bin/rvn
          fi

      - name: Setup sysroot
        run: |
          chmod +x scripts/stages/stage2-native.sh
          export RAVEN_ROOT="${PWD}"
          export RAVEN_BUILD="${PWD}/build"
          sudo -E ./scripts/stages/stage2-native.sh

      - name: Build initramfs
        run: |
          chmod +x scripts/build-initramfs.sh
          export RAVEN_ROOT="${PWD}"
          export RAVEN_BUILD="${PWD}/build"
          # Initramfs build needs sudo for mknod device nodes
          sudo -E ./scripts/build-initramfs.sh

      - name: Build ISO
        run: |
          chmod +x scripts/stages/stage4-iso.sh
          export RAVEN_ROOT="${PWD}"
          export RAVEN_BUILD="${PWD}/build"
          export RAVEN_VERSION="${{ env.RAVEN_VERSION }}"
          export PACKAGES_DIR="${PWD}/build/packages"
          sudo -E ./scripts/stages/stage4-iso.sh

      - name: Generate checksums
        run: |
          sha256sum raven-*.iso > raven-${{ env.RAVEN_VERSION }}-x86_64.iso.sha256
          md5sum raven-*.iso > raven-${{ env.RAVEN_VERSION }}-x86_64.iso.md5

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: ravenlinux-iso
          path: |
            raven-*.iso
            raven-*.iso.sha256
            raven-*.iso.md5
          if-no-files-found: warn

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-go, build-rust, build-bootloader]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create source tarball
        run: |
          # Create a clean source tarball for building from source
          # Exclude build artifacts, .git, and other unnecessary files
          tar --exclude='.git' \
              --exclude='build' \
              --exclude='*.iso' \
              --exclude='target' \
              --exclude='*.o' \
              --exclude='*.a' \
              --exclude='.github/workflows/*.log' \
              -czvf ravenlinux-${{ github.ref_name }}-source.tar.gz \
              --transform "s,^,ravenlinux-${{ github.ref_name }}/," \
              .

      - name: Prepare release assets
        run: |
          mkdir -p release

          # ===========================================
          # STANDALONE: raven-usb (USB flasher tool)
          # ===========================================
          cp artifacts/go-packages/raven-usb raven-usb-${{ github.ref_name }}-linux-x86_64
          chmod +x raven-usb-${{ github.ref_name }}-linux-x86_64

          # ===========================================
          # Tools bundle (all other tools)
          # ===========================================
          # Go packages
          cp artifacts/go-packages/vem release/vem-linux-x86_64
          cp artifacts/go-packages/carrion release/carrion-linux-x86_64
          cp artifacts/go-packages/ivaldi release/ivaldi-linux-x86_64
          cp artifacts/go-packages/raven-installer release/raven-installer-linux-x86_64
          cp artifacts/go-packages/raven-usb release/raven-usb-linux-x86_64
          cp artifacts/go-packages/raven-wifi release/raven-wifi-linux-x86_64
          cp artifacts/go-packages/wifi release/wifi-linux-x86_64
          chmod +x release/vem-linux-x86_64 release/carrion-linux-x86_64 release/ivaldi-linux-x86_64
          chmod +x release/raven-installer-linux-x86_64 release/raven-usb-linux-x86_64 release/raven-wifi-linux-x86_64
          chmod +x release/wifi-linux-x86_64

          # Package manager (Rust)
          if [[ -f artifacts/rvn-linux-x86_64/rvn ]]; then
            cp artifacts/rvn-linux-x86_64/rvn release/rvn-linux-x86_64
            chmod +x release/rvn-linux-x86_64
          fi

          # Init system (if built)
          if [[ -f artifacts/raven-init-linux-x86_64/raven-init ]]; then
            cp artifacts/raven-init-linux-x86_64/raven-init release/raven-init-linux-x86_64
            chmod +x release/raven-init-linux-x86_64
          fi
          if [[ -f artifacts/raven-rc-linux-x86_64/raven-rc ]]; then
            cp artifacts/raven-rc-linux-x86_64/raven-rc release/raven-rc-linux-x86_64
            chmod +x release/raven-rc-linux-x86_64
          fi

          # Bootloader
          cp artifacts/raven-boot-efi/raven-boot.efi release/raven-boot.efi

          # Create checksums for tools
          cd release
          sha256sum * > SHA256SUMS

          # Create tools tarball
          cd ..
          tar czvf ravenlinux-tools-${{ github.ref_name }}-linux-x86_64.tar.gz -C release .

          # Create checksums for all release files
          sha256sum ravenlinux-${{ github.ref_name }}-source.tar.gz > ravenlinux-${{ github.ref_name }}-source.tar.gz.sha256
          sha256sum raven-usb-${{ github.ref_name }}-linux-x86_64 > raven-usb-${{ github.ref_name }}-linux-x86_64.sha256
          sha256sum ravenlinux-tools-${{ github.ref_name }}-linux-x86_64.tar.gz > ravenlinux-tools-${{ github.ref_name }}-linux-x86_64.tar.gz.sha256

      - name: Generate release notes
        run: |
          cat << 'EOF' > RELEASE_NOTES.md
          # RavenLinux ${{ github.ref_name }}

          ## Downloads

          | File | Description |
          |------|-------------|
          | `ravenlinux-${{ github.ref_name }}.iso` | Bootable ISO image - burn to USB and boot |
          | `raven-usb-${{ github.ref_name }}-linux-x86_64` | USB flasher tool - use to write ISO to USB drive |
          | `ravenlinux-${{ github.ref_name }}-source.tar.gz` | Complete source code for building from scratch |
          | `ravenlinux-tools-${{ github.ref_name }}-linux-x86_64.tar.gz` | All tools bundled together |

          ## Quick Start

          ### Option 1: Flash ISO to USB
          ```bash
          # Download the ISO and raven-usb tool
          chmod +x raven-usb-*-linux-x86_64
          sudo ./raven-usb-*-linux-x86_64 ravenlinux-*.iso /dev/sdX
          ```

          ### Option 2: Build from Source
          ```bash
          # Extract and build
          tar xzf ravenlinux-${{ github.ref_name }}-source.tar.gz
          cd ravenlinux-${{ github.ref_name }}
          ./scripts/build.sh
          ```

          ## Components

          | Component | Description |
          |-----------|-------------|
          | `vem` | Text editor with syntax highlighting |
          | `carrion` | Carrion programming language |
          | `ivaldi` | Version control system |
          | `rvn` | RavenLinux package manager |
          | `raven-installer` | GUI system installer |
          | `raven-usb` | USB bootable drive creator |
          | `wifi` | Simple TUI WiFi manager (recommended) |
          | `raven-wifi` | Full GUI WiFi manager |
          | `raven-boot.efi` | UEFI bootloader |

          ## Individual Tool Installation

          ```bash
          # Text editor
          sudo install -m 755 vem-linux-x86_64 /usr/local/bin/vem

          # Carrion language
          sudo install -m 755 carrion-linux-x86_64 /usr/local/bin/carrion

          # Version control
          sudo install -m 755 ivaldi-linux-x86_64 /usr/local/bin/ivaldi

          # Package manager
          sudo install -m 755 rvn-linux-x86_64 /usr/local/bin/rvn
          ```

          ## Checksums

          See `SHA256SUMS` file for verification.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            ravenlinux-${{ github.ref_name }}-source.tar.gz
            ravenlinux-${{ github.ref_name }}-source.tar.gz.sha256
            raven-usb-${{ github.ref_name }}-linux-x86_64
            raven-usb-${{ github.ref_name }}-linux-x86_64.sha256
            ravenlinux-tools-${{ github.ref_name }}-linux-x86_64.tar.gz
            ravenlinux-tools-${{ github.ref_name }}-linux-x86_64.tar.gz.sha256
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Full ISO Release (when kernel is built)
  # ===========================================================================
  release-iso:
    name: Release ISO
    runs-on: ubuntu-latest
    needs: [build-iso, release]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: ravenlinux-iso
          path: iso

      - name: Prepare ISO for release
        run: |
          # Rename ISO to include version tag
          cd iso
          for f in raven-*.iso; do
            if [ -f "$f" ]; then
              mv "$f" "ravenlinux-${{ github.ref_name }}.iso"
            fi
          done

          # Generate checksums for ISO
          sha256sum ravenlinux-${{ github.ref_name }}.iso > ravenlinux-${{ github.ref_name }}.iso.sha256
          md5sum ravenlinux-${{ github.ref_name }}.iso > ravenlinux-${{ github.ref_name }}.iso.md5

      - name: Upload ISO to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            iso/ravenlinux-${{ github.ref_name }}.iso
            iso/ravenlinux-${{ github.ref_name }}.iso.sha256
            iso/ravenlinux-${{ github.ref_name }}.iso.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
